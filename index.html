、<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>STREET RACER</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:Arial,sans-serif}
#c{width:100%;height:100%;display:block;touch-action:none}
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}

/* スピードメーター */
#spedo{
  position:absolute;bottom:185px;right:12px;
  background:rgba(0,0,0,.78);border:2px solid #f60;
  border-radius:12px;padding:8px 14px;color:#fff;text-align:center;min-width:98px
}
#spd{font-size:34px;font-weight:700;color:#f60;line-height:1}
#sunit{font-size:10px;color:#aaa}
#rpmwrap{width:100%;background:#333;border-radius:4px;height:6px;margin-top:5px}
#rpmbar{height:6px;background:linear-gradient(90deg,#0f0,#ff0,#f00);border-radius:4px;width:0%}
#geardsp{font-size:22px;font-weight:700;color:#fff;margin-top:3px}

/* 縦画面コントローラー */
#ctrl{
  position:absolute;bottom:0;left:0;right:0;height:175px;
  display:grid;grid-template-columns:1fr 1fr 1fr;
  align-items:center;padding:10px 14px;pointer-events:auto;
  background:linear-gradient(transparent,rgba(0,0,0,.4))
}
.btn{
  width:64px;height:64px;border-radius:50%;
  border:2.5px solid rgba(255,255,255,.32);background:rgba(0,0,0,.52);
  color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent;
  backdrop-filter:blur(4px);font-weight:700;touch-action:none;
  transition:background .08s,border-color .08s
}
.btn.act{background:rgba(255,102,0,.72);border-color:#f60}
#bacc{width:72px;height:72px;font-size:28px;background:rgba(0,160,0,.52);border-color:#0c0}
#bbrk{background:rgba(160,0,0,.52);border-color:#c00}
#la{display:flex;gap:9px;justify-content:flex-start;align-items:center}
#ma{display:flex;flex-direction:column;gap:8px;align-items:center}
#ra{display:flex;flex-direction:column;gap:5px;align-items:flex-end}
.gbtn{width:46px;height:46px;border-radius:8px;font-size:14px;font-weight:700}

/* 情報 */
#info{
  position:absolute;top:8px;left:8px;
  background:rgba(0,0,0,.62);border:1px solid #f60;
  border-radius:8px;padding:5px 9px;color:#fff;font-size:11px;line-height:1.5
}
/* ミニマップ */
#mmap{
  position:absolute;top:8px;right:8px;width:98px;height:98px;
  border:2px solid #f60;border-radius:50%;overflow:hidden
}
#mmcv{width:100%;height:100%}

/* ローディング */
#ld{
  position:fixed;inset:0;background:#111;
  display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200
}
#ld h1{font-size:40px;color:#f60;letter-spacing:4px;margin-bottom:6px}
#ld p{color:#aaa;font-size:14px;margin-bottom:20px}
#pgwrap{width:260px;background:#222;border-radius:20px;height:6px}
#pgbar{height:6px;background:#f60;border-radius:20px;width:0%;transition:width .25s}
</style>
</head>
<body>
<div id="ld">
  <h1>STREET RACER</h1>
  <p id="ldtxt">Loading...</p>
  <div id="pgwrap"><div id="pgbar"></div></div>
</div>

<canvas id="c"></canvas>

<div id="hud">
  <div id="info">
    <div id="ipos">POS: 0, 0</div>
    <div id="ichk">CHUNKS: 0</div>
    <div id="inpc">NPCs: 0 | FPS: 0</div>
  </div>
  <div id="mmap"><canvas id="mmcv" width="98" height="98"></canvas></div>
  <div id="spedo">
    <div id="spd">0</div>
    <div id="sunit">km/h</div>
    <div id="rpmwrap"><div id="rpmbar"></div></div>
    <div id="geardsp">D</div>
  </div>
  <div id="ctrl">
    <div id="la">
      <div class="btn" id="blft">◀</div>
      <div class="btn" id="brgt">▶</div>
    </div>
    <div id="ma">
      <div class="btn" id="bacc">▲</div>
      <div class="btn" id="bbrk">■</div>
    </div>
    <div id="ra">
      <div class="btn gbtn" id="bd">D</div>
      <div class="btn gbtn" id="br2">R</div>
      <div class="btn gbtn" id="bn">N</div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const setPg=(p,t)=>{$('pgbar').style.width=p+'%';if(t)$('ldtxt').textContent=t;};

function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;
    document.head.appendChild(s);
  });
}

// ── ノイズ ──
function n2(x,z){return(Math.sin(x*127.1)*43758.5453+Math.sin(z*311.7)*43758.5453)%1;}
function sn(x,z,sc=0.008){
  const ix=Math.floor(x*sc),iz=Math.floor(z*sc);
  const fx=x*sc-ix,fz=z*sc-iz;
  const ux=fx*fx*(3-2*fx),uz=fz*fz*(3-2*fz);
  const a=(n2(ix,iz)+2)%1,b=(n2(ix+1,iz)+2)%1,c=(n2(ix,iz+1)+2)%1,d=(n2(ix+1,iz+1)+2)%1;
  return a*(1-ux)*(1-uz)+b*ux*(1-uz)+c*(1-ux)*uz+d*ux*uz;
}
function getH(x,z){
  const mx=((x%200)+200)%200,mz=((z%200)+200)%200;
  const roadMask=Math.max(
    Math.max(0,1-Math.min(mz,200-mz)/18),
    Math.max(0,1-Math.min(mx,200-mx)/18)
  );
  return(sn(x,z)*12-2+sn(x,z,.025)*3)*(1-roadMask*.97);
}

// ── メイン ──
async function main(){
  setPg(10,'Loading PlayCanvas...');
  await loadScript('https://code.playcanvas.com/playcanvas-stable.min.js');
  setPg(50,'Initializing...');
  await new Promise(r=>setTimeout(r,100));
  initGame();
}
main().catch(e=>{ $('ld').innerHTML=`<h2 style="color:red">Error</h2><pre style="color:#f88;font-size:10px">${e.stack||e}</pre>`; });

// =====================================================================
function initGame(){
  const canvas=$('c');
  const app=new pc.Application(canvas,{
    mouse:new pc.Mouse(canvas),touch:new pc.TouchDevice(canvas),
    keyboard:new pc.Keyboard(window),
    graphicsDeviceOptions:{antialias:true,alpha:false,powerPreference:'high-performance'}
  });
  app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
  app.setCanvasResolution(pc.RESOLUTION_AUTO);
  app.start();

  // ── テクスチャ生成 ──
  function pcTex(w,h,fn,rep=true){
    const cv=document.createElement('canvas');cv.width=w;cv.height=h;
    fn(cv.getContext('2d'),w,h);
    const t=new pc.Texture(app.graphicsDevice,{
      width:w,height:h,format:pc.PIXELFORMAT_R8_G8_B8_A8,mipmaps:true,
      minFilter:pc.FILTER_LINEAR_MIPMAP_LINEAR,magFilter:pc.FILTER_LINEAR,
      addressU:rep?pc.ADDRESS_REPEAT:pc.ADDRESS_CLAMP_TO_EDGE,
      addressV:rep?pc.ADDRESS_REPEAT:pc.ADDRESS_CLAMP_TO_EDGE
    });
    t.setSource(cv);return t;
  }

  const TX={
    asphalt:pcTex(256,256,(ctx,w,h)=>{
      ctx.fillStyle='#252525';ctx.fillRect(0,0,w,h);
      for(let i=0;i<5000;i++){const v=18+Math.random()*32;ctx.fillStyle=`rgb(${v},${v},${v})`;ctx.fillRect(Math.random()*w,Math.random()*h,2,2);}
      ctx.strokeStyle='#ddbb00';ctx.lineWidth=5;ctx.setLineDash([36,28]);
      ctx.beginPath();ctx.moveTo(w/2,0);ctx.lineTo(w/2,h);ctx.stroke();
      ctx.strokeStyle='#ccc';ctx.lineWidth=2;ctx.setLineDash([16,18]);
      [w/4,3*w/4].forEach(x=>{ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();});
    }),
    concrete:pcTex(256,256,(ctx,w,h)=>{
      ctx.fillStyle='#888';ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#666';ctx.lineWidth=1.5;
      for(let y=0;y<h;y+=40)for(let x=0;x<w;x+=60)ctx.strokeRect(x+1,y+1,58,38);
      for(let i=0;i<2000;i++){const v=100+Math.random()*40;ctx.globalAlpha=.18;ctx.fillStyle=`rgb(${v},${v},${v})`;ctx.fillRect(Math.random()*w,Math.random()*h,2,2);}
      ctx.globalAlpha=1;
    }),
    wallA:pcTex(256,512,(ctx,w,h)=>{
      ctx.fillStyle='#7a7a7a';ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#5e5e5e';ctx.lineWidth=1.5;
      for(let y=0;y<h;y+=42){const off=Math.floor(y/42)%2*29;for(let x=-off;x<w;x+=58)ctx.strokeRect(x+1,y+1,56,40);}
      for(let i=0;i<2500;i++){ctx.globalAlpha=.2;ctx.fillStyle=`rgb(${90+Math.random()*40|0},${90+Math.random()*40|0},${90+Math.random()*40|0})`;ctx.fillRect(Math.random()*w,Math.random()*h,2,2);}
      ctx.globalAlpha=1;
    }),
    wallB:pcTex(256,512,(ctx,w,h)=>{
      const g=ctx.createLinearGradient(0,0,w,h);g.addColorStop(0,'#152e4a');g.addColorStop(1,'#1c4a72');
      ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
      for(let y=7;y<h-24;y+=31)for(let x=7;x<w-34;x+=41){
        ctx.fillStyle=Math.random()<.55?`rgba(255,235,155,${.22+Math.random()*.5})`:'rgba(28,65,105,.8)';
        ctx.fillRect(x,y,32,22);ctx.strokeStyle='rgba(170,205,255,.2)';ctx.lineWidth=1;ctx.strokeRect(x,y,32,22);
      }
    }),
    water:pcTex(256,256,(ctx,w,h)=>{
      const g=ctx.createLinearGradient(0,0,0,h);g.addColorStop(0,'#0a3360');g.addColorStop(.5,'#144e8a');g.addColorStop(1,'#0a3f6e');
      ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='rgba(80,160,255,.32)';ctx.lineWidth=1.5;
      for(let i=0;i<9;i++){const y=(i/9)*h;ctx.beginPath();for(let x=0;x<w;x+=4){const wy=y+Math.sin((x/w)*Math.PI*7+i)*5;x===0?ctx.moveTo(x,wy):ctx.lineTo(x,wy);}ctx.stroke();}
    }),
    roof:pcTex(256,256,(ctx,w,h)=>{
      ctx.fillStyle='#4e4e4e';ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#3a3a3a';ctx.lineWidth=1;
      for(let i=0;i<w;i+=32)ctx.strokeRect(i,0,32,h);for(let j=0;j<h;j+=32)ctx.strokeRect(0,j,w,32);
    }),
    bridge:pcTex(256,256,(ctx,w,h)=>{
      ctx.fillStyle='#787878';ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#636363';ctx.lineWidth=3;
      for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(0,(i/6)*h);ctx.lineTo(w,(i/6)*h);ctx.stroke();}
      ctx.strokeStyle='#575757';ctx.lineWidth=2;
      for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(i*w/5,0);ctx.lineTo((i+1)*w/5,h);ctx.stroke();ctx.beginPath();ctx.moveTo((i+1)*w/5,0);ctx.lineTo(i*w/5,h);ctx.stroke();}
    }),
    skid:pcTex(64,256,(ctx,w,h)=>{
      ctx.clearRect(0,0,w,h);ctx.fillStyle='rgba(8,8,8,.8)';
      ctx.fillRect(4,0,14,h);ctx.fillRect(w-18,0,14,h);
    }),
    tire:pcTex(64,64,(ctx,w,h)=>{
      ctx.fillStyle='#1a1a1a';ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#3a3a3a';ctx.lineWidth=2.5;
      for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;ctx.beginPath();ctx.moveTo(w/2,h/2);ctx.lineTo(w/2+Math.cos(a)*w/2,h/2+Math.sin(a)*h/2);ctx.stroke();}
      ctx.strokeStyle='#555';ctx.lineWidth=4;ctx.beginPath();ctx.arc(w/2,h/2,w/2-4,0,Math.PI*2);ctx.stroke();
    })
  };

  function tCar(r,g,b){
    return pcTex(128,128,(ctx,w,h)=>{
      const gr=ctx.createLinearGradient(0,0,0,h);
      gr.addColorStop(0,`rgb(${Math.min(255,r+60)},${Math.min(255,g+60)},${Math.min(255,b+60)})`);
      gr.addColorStop(.5,`rgb(${r},${g},${b})`);
      gr.addColorStop(1,`rgb(${Math.max(0,r-40)},${Math.max(0,g-40)},${Math.max(0,b-40)})`);
      ctx.fillStyle=gr;ctx.fillRect(0,0,w,h);
      ctx.fillStyle='rgba(255,255,255,.15)';ctx.fillRect(8,4,w-16,16);
    },false);
  }

  function mat(tex,tu=1,tv=1){
    const m=new pc.StandardMaterial();
    m.diffuseMap=tex;m.diffuseMapTiling=new pc.Vec2(tu,tv);
    m.roughness=.84;m.metalness=.04;m.update();return m;
  }

  // ── ライト ──
  const sun=new pc.Entity('sun');
  sun.addComponent('light',{type:'directional',color:new pc.Color(1,.95,.85),intensity:1.6,
    castShadows:true,shadowBias:.2,shadowResolution:1024,shadowRange:120});
  sun.setEulerAngles(45,130,0);app.root.addChild(sun);
  const fill=new pc.Entity('fill');
  fill.addComponent('light',{type:'directional',color:new pc.Color(.3,.5,.72),intensity:.42});
  fill.setEulerAngles(-30,0,0);app.root.addChild(fill);

  // ── カメラ ──
  const camE=new pc.Entity('cam');
  camE.addComponent('camera',{fov:65,nearClip:.4,farClip:500,clearColor:new pc.Color(.5,.7,.9)});
  app.root.addChild(camE);

  // =====================================================================
  //  チャンク
  // =====================================================================
  const CSIZ=200,RDIST=2;
  const chunkMap=new Map();

  function createChunk(cx,cz){
    const k=cx+','+cz;if(chunkMap.has(k))return;
    const wx=cx*CSIZ,wz=cz*CSIZ;const ents=[];

    // 地面
    {
      const segs=14,step=CSIZ/segs,pos=[],uvs=[],norms=[],inds=[];
      for(let zi=0;zi<=segs;zi++)for(let xi=0;xi<=segs;xi++){
        const lx=xi*step,lz=zi*step,h=getH(wx+lx,wz+lz);
        pos.push(lx-CSIZ/2,h,lz-CSIZ/2);uvs.push(xi/segs*6,zi/segs*6);norms.push(0,1,0);
      }
      for(let zi=0;zi<segs;zi++)for(let xi=0;xi<segs;xi++){
        const i=zi*(segs+1)+xi;inds.push(i,i+segs+1,i+1,i+1,i+segs+1,i+segs+2);
      }
      for(let i=0;i<inds.length;i+=3){
        const i0=inds[i]*3,i1=inds[i+1]*3,i2=inds[i+2]*3;
        const ax=pos[i1]-pos[i0],ay=pos[i1+1]-pos[i0+1],az=pos[i1+2]-pos[i0+2];
        const bx=pos[i2]-pos[i0],by=pos[i2+1]-pos[i0+1],bz=pos[i2+2]-pos[i0+2];
        const nx=ay*bz-az*by,ny=az*bx-ax*bz,nz=ax*by-ay*bx;
        const ln=Math.sqrt(nx*nx+ny*ny+nz*nz)+.001;
        for(let j=0;j<3;j++){const ii=inds[i+j];norms[ii*3]+=nx/ln;norms[ii*3+1]+=ny/ln;norms[ii*3+2]+=nz/ln;}
      }
      const mesh=new pc.Mesh(app.graphicsDevice);
      mesh.setPositions(pos);mesh.setNormals(norms);mesh.setUvs(0,uvs);mesh.setIndices(inds);mesh.update();
      const ge=new pc.Entity('g'+k);
      ge.addComponent('render',{meshInstances:[new pc.MeshInstance(mesh,mat(TX.concrete,6,6))]});
      ge.setPosition(wx+CSIZ/2,0,wz+CSIZ/2);app.root.addChild(ge);ents.push(ge);
    }

    const rng=s=>(Math.sin(cx*1637+cz*311+s)*.5+.5);
    const mh=getH(wx+CSIZ/2,wz+CSIZ/2);

    // 道路X
    {const e=new pc.Entity();e.addComponent('render',{type:'plane',material:mat(TX.asphalt,8,1)});
    e.setLocalScale(CSIZ,1,22);e.setPosition(wx+CSIZ/2,mh+.06,wz+CSIZ/2);app.root.addChild(e);ents.push(e);}
    // 道路Z
    {const e=new pc.Entity();e.addComponent('render',{type:'plane',material:mat(TX.asphalt,1,8)});
    e.setLocalScale(22,1,CSIZ);e.setPosition(wx+CSIZ/2,mh+.06,wz+CSIZ/2);app.root.addChild(e);ents.push(e);}

    // 川
    if(rng(0)>.58){
      const rvx=wx+CSIZ*.2+rng(1)*CSIZ*.15,rvy=getH(rvx,wz+CSIZ/2)-.25,rvw=20+rng(2)*16;
      const rv=new pc.Entity();rv.addComponent('render',{type:'plane',material:mat(TX.water,3,7)});
      rv.setLocalScale(rvw,1,CSIZ);rv.setPosition(rvx,rvy,wz+CSIZ/2);app.root.addChild(rv);ents.push(rv);
      const br=new pc.Entity();br.addComponent('render',{type:'box',material:mat(TX.bridge,2,1)});
      br.setLocalScale(rvw+5,1.1,24);br.setPosition(rvx,Math.max(getH(rvx,wz+CSIZ/2),rvy)+.55,wz+CSIZ/2);
      app.root.addChild(br);ents.push(br);
    }

    // ビル
    for(let bi=0;bi<Math.floor(2+rng(10)*5);bi++){
      const bx=wx+rng(bi*7+1)*CSIZ,bz=wz+rng(bi*7+2)*CSIZ;
      if(Math.abs(bz-(wz+CSIZ/2))<22||Math.abs(bx-(wx+CSIZ/2))<22)continue;
      const bw=12+rng(bi*7+3)*20,bd=12+rng(bi*7+4)*20,bh=16+rng(bi*7+5)*85,gh=getH(bx,bz);
      const wm=mat(rng(bi*7+6)>.45?TX.wallB:TX.wallA,1,bh/18);
      const be=new pc.Entity();be.addComponent('render',{type:'box',material:wm});
      be.setLocalScale(bw,bh,bd);be.setPosition(bx,gh+bh/2,bz);be.setEulerAngles(0,rng(bi*7+7)*12-6,0);
      app.root.addChild(be);ents.push(be);
      const rf=new pc.Entity();rf.addComponent('render',{type:'box',material:mat(TX.roof)});
      rf.setLocalScale(bw,.4,bd);rf.setPosition(bx,gh+bh+.2,bz);app.root.addChild(rf);ents.push(rf);
    }
    chunkMap.set(k,ents);
  }
  function removeChunk(k){const ents=chunkMap.get(k);if(!ents)return;ents.forEach(e=>e.destroy());chunkMap.delete(k);}

  // =====================================================================
  //  カー物理
  //  前方 = yaw=0 のとき +Z 方向
  //  forward = { x: sin(yaw), z: cos(yaw) }
  //  D ギア → drive > 0 → +Z方向へ進む = 前進  ✓
  // =====================================================================
  class CarPhysics{
    constructor(x,y,z){
      this.pos=new pc.Vec3(x,y,z);
      this.vel=new pc.Vec3();
      this.yaw=0;      // 0=+Z前方
      this.pitch=0;this.roll=0;
      this.angVel=0;
      this.mass=1400;
      this.WB=2.8;this.TW=1.8;
      this.rpm=800;
      this.accelIn=0;this.brakeIn=0;
      this.steer=0;
      this.slip=0;this.onGround=false;
      this.localFwd=0;this.localSide=0;
      this.wheelRot=0;// 転がり角度(rad)
    }
    // +Z方向が前
    fwd(){return{x:Math.sin(this.yaw),z:Math.cos(this.yaw)};}
    rgt(){return{x:Math.cos(this.yaw),z:-Math.sin(this.yaw)};}

    update(dt,inp){
      const{accel,brake,left,right,gear}=inp;

      // 入力平滑
      this.accelIn+=(( accel?1:0)-this.accelIn)*Math.min(1,dt*(accel?2.5:6));
      this.brakeIn+=((brake?1:0)-this.brakeIn)*Math.min(1,dt*(brake?8:10));
      const steerMax=Math.max(.25,1-Math.abs(this.localFwd)/48);
      const steerTgt=(left?1:right?-1:0)*steerMax;
      this.steer+=(steerTgt-this.steer)*Math.min(1,dt*7);

      // 4輪地形
      const f=this.fwd(),r=this.rgt();
      const hw=this.WB/2,ht=this.TW/2;
      const wp=[
        {x:this.pos.x+r.x*ht+f.x*hw,z:this.pos.z+r.z*ht+f.z*hw},
        {x:this.pos.x-r.x*ht+f.x*hw,z:this.pos.z-r.z*ht+f.z*hw},
        {x:this.pos.x+r.x*ht-f.x*hw,z:this.pos.z+r.z*ht-f.z*hw},
        {x:this.pos.x-r.x*ht-f.x*hw,z:this.pos.z-r.z*ht-f.z*hw},
      ];
      const gh=wp.map(p=>getH(p.x,p.z));

      // サスペンション
      let netFy=-this.mass*13;this.onGround=false;
      for(let i=0;i<4;i++){
        const pen=gh[i]+0.42-this.pos.y;
        if(pen>0){this.onGround=true;netFy+=52000*pen-3000*this.vel.y;}
      }

      // ローカル速度
      this.localFwd =this.vel.x*f.x+this.vel.z*f.z;
      this.localSide=this.vel.x*r.x+this.vel.z*r.z;

      // 駆動力（D=正=前進 / R=負=後退）
      const MAX_SPD=52;let drive=0;
      if(gear==='D'){
        // 前進方向(localFwd+)へ力を出す
        drive=this.accelIn*4800*Math.max(0,1-this.localFwd/MAX_SPD);
        if(this.localFwd<0)drive+=this.accelIn*2500;
      } else if(gear==='R'){
        // 後退方向(localFwd-)へ力を出す
        drive=-this.accelIn*2000*Math.max(0,1+this.localFwd/16);
      }
      // N=0

      // RPM
      const gi=Math.min(Math.floor(Math.abs(this.localFwd)/8),5);
      this.rpm=Math.min(7500,800+this.accelIn*2800+Math.abs(this.localFwd)*[4,3.2,2.2,1.6,1.2,1][gi]*160);

      // 摩擦
      const isBurn=accel&&brake&&Math.abs(this.localFwd)<3&&gear==='D';
      const fricFwd=this.onGround?(this.brakeIn>.08?(600+this.brakeIn*3600):95):14;
      const fricLat=this.onGround?(isBurn?220:2500):40;
      this.slip=Math.min(1,Math.abs(this.localSide)/(Math.abs(this.localFwd)+1));
      if(isBurn)this.slip=1;
      const rLat=Math.max(80,2500-Math.abs(this.localFwd)*20);
      const latF=-(isBurn?this.localSide*180:this.localSide*(this.slip>.28?rLat:fricLat));
      const fwdF=drive-this.localFwd*fricFwd;

      // ヨー
      if(this.onGround&&Math.abs(this.localFwd)>.5){
        const tr=Math.tan(this.steer)*this.localFwd/this.WB;
        this.angVel+=(tr-this.angVel)*Math.min(1,dt*9);
      }
      if(this.slip>.22&&this.onGround)this.angVel+=this.localSide*.005;
      this.angVel*=Math.max(0,1-dt*(this.onGround?4.5:1));
      this.yaw+=this.angVel*dt;

      // 加速
      if(this.onGround){
        this.vel.x+=(f.x*fwdF+r.x*latF)/this.mass*dt;
        this.vel.z+=(f.z*fwdF+r.z*latF)/this.mass*dt;
        const spd=Math.sqrt(this.vel.x*this.vel.x+this.vel.z*this.vel.z);
        if(spd>MAX_SPD){this.vel.x*=MAX_SPD/spd;this.vel.z*=MAX_SPD/spd;}
        this.vel.y+=netFy/this.mass*dt;this.vel.y*=.65;
      } else this.vel.y-=14*dt;

      this.pos.x+=this.vel.x*dt;this.pos.y+=this.vel.y*dt;this.pos.z+=this.vel.z*dt;
      const mh=getH(this.pos.x,this.pos.z);
      if(this.pos.y<mh+.12){this.pos.y=mh+.12;if(this.vel.y<0)this.vel.y=0;}

      // ピッチ・ロール
      const af=(gh[0]+gh[1])/2,ar=(gh[2]+gh[3])/2;
      const al=(gh[0]+gh[2])/2,arv=(gh[1]+gh[3])/2;
      this.pitch+=(Math.atan2(ar-af,this.WB)*.8-this.pitch)*Math.min(1,dt*6);
      this.roll +=(Math.atan2(arv-al,this.TW)*.55-this.roll)*Math.min(1,dt*6);

      // タイヤ転がり：前進→正回転、後退→負回転
      this.wheelRot+=this.localFwd/0.4*dt; // radius≈0.4m

      return{slip:this.slip,speedKmh:this.localFwd*3.6,rpm:this.rpm,onGround:this.onGround,isBurn};
    }
  }

  // =====================================================================
  //  プレイヤー車両
  // =====================================================================
  const CAR_COLORS=[[210,40,40],[40,90,210],[40,170,70],[210,170,40],[160,40,210],[40,190,190]];
  const pCol=CAR_COLORS[Math.floor(Math.random()*CAR_COLORS.length)];

  // carRoot = 車体エンティティ（位置・向きを毎フレーム更新）
  const carRoot=new pc.Entity('carRoot');
  app.root.addChild(carRoot);

  // タイヤ4つ（carRootの外・ワールド空間）
  const tireMat=mat(TX.tire);
  const wheelEnts=[];
  for(let i=0;i<4;i++){
    const we=new pc.Entity('w'+i);
    we.addComponent('render',{type:'cylinder',material:tireMat});
    we.setLocalScale(.44,.3,.44);
    app.root.addChild(we);
    wheelEnts.push(we);
  }

  // 車体ビジュアル（GLBまたはプロシージャル）
  // ── ローカルオフセット（車体基準 x=右, z=前/後）
  const WOFF=[
    {x:-1.05,y:-.3,z:-1.3},  // FL
    {x: 1.05,y:-.3,z:-1.3},  // FR
    {x:-1.05,y:-.3,z: 1.3},  // RL
    {x: 1.05,y:-.3,z: 1.3},  // RR
  ];

  function buildFallbackCar(){
    const ctex=tCar(...pCol);
    const bm=new pc.Entity();bm.addComponent('render',{type:'box',material:mat(ctex,1,1)});
    bm.setLocalScale(2,.72,4.5);carRoot.addChild(bm);
    const rm=new pc.Entity();rm.addComponent('render',{type:'box',material:mat(ctex,1,1)});
    rm.setLocalScale(1.5,.55,2.0);rm.setLocalPosition(0,.64,.1);carRoot.addChild(rm);
    const hlM=new pc.StandardMaterial();hlM.emissive=new pc.Color(1,1,.8);hlM.emissiveIntensity=1.3;hlM.update();
    [[-0.68,-.04,-2.3],[0.68,-.04,-2.3]].forEach(p=>{
      const h=new pc.Entity();h.addComponent('render',{type:'box',material:hlM});
      h.setLocalScale(.42,.18,.07);h.setLocalPosition(...p);carRoot.addChild(h);
    });
    const tlM=new pc.StandardMaterial();tlM.emissive=new pc.Color(.9,.08,.08);tlM.emissiveIntensity=1.1;tlM.update();
    [[-0.68,-.04,2.3],[0.68,-.04,2.3]].forEach(p=>{
      const t=new pc.Entity();t.addComponent('render',{type:'box',material:tlM});
      t.setLocalScale(.38,.16,.06);t.setLocalPosition(...p);carRoot.addChild(t);
    });
  }

  // GLBをbase64として埋め込む代わりに、同じディレクトリのCar.glbを相対URLで読む
  // HTMLと同じフォルダにCar.glbを置けば自動ロード
  // もしくはGitHub Raw URLを直接指定

  // Car.glbを同階層から読む試み → 失敗したらプロシージャル
  const GLB_URLS=[
    'Car.glb',
    './Car.glb',
    // GitHubのRaw URL（ユーザーがリポジトリに置いた場合の汎用パターン）
    // 実際のURLに変えて使う場合はここを書き換え
  ];

  let glbLoaded=false;

  function tryLoadGlb(urls,idx=0){
    if(idx>=urls.length){
      buildFallbackCar();
      finishLoading();
      return;
    }
    const url=urls[idx];
    const asset=new pc.Asset('car','container',{url});
    app.assets.add(asset);
    asset.on('load',()=>{
      const res=asset.resource;
      if(res&&res.instantiateRenderEntity){
        const glbE=res.instantiateRenderEntity();
        // GLBはscale=0.01,rotationX=90°が焼き込まれているので
        // carRootに追加するだけでOK
        // ただしGLB内のCarノードはすでに補正済みなのでlocalScaleを1にリセット
        glbE.setLocalScale(1,1,1);
        glbE.setLocalPosition(0,0,0);
        glbE.setLocalEulerAngles(0,0,0);
        carRoot.addChild(glbE);
        glbLoaded=true;
        finishLoading();
      } else {
        tryLoadGlb(urls,idx+1);
      }
    });
    asset.on('error',()=>tryLoadGlb(urls,idx+1));
    app.assets.load(asset);
  }

  function finishLoading(){
    setPg(100,'Ready!');
    setTimeout(()=>{ $('ld').style.display='none'; },300);
  }

  tryLoadGlb(GLB_URLS);
  const carPhys=new CarPhysics(0,5,0);

  // タイヤ位置更新（ワールド空間・carRootの外）
  function updateWheels(p){
    const f=p.fwd(),r=p.rgt();
    // ステアリング（前輪のみ）
    const sa=p.steer;
    WOFF.forEach((off,i)=>{
      // ワールド座標
      const wx=p.pos.x+r.x*off.x+f.x*off.z;
      const wy=p.pos.y+off.y;
      const wz=p.pos.z+r.z*off.x+f.z*off.z;
      wheelEnts[i].setPosition(wx,wy,wz);

      // 回転：
      //   cylinder はデフォルトでY軸方向に立っている
      //   横向きにするには Z軸を90度回転
      //   車体のヨー方向を加える
      //   前輪(i<2)はさらにステア角を加える
      const steerAngle=(i<2)?sa:0;
      const totalYaw=p.yaw+steerAngle; // ラジアン

      // EulerAngles: X=転がり, Y=ヨー（度）, Z=90（横向き）
      const rollDeg=p.wheelRot*180/Math.PI;
      const yawDeg=-totalYaw*180/Math.PI;
      wheelEnts[i].setEulerAngles(rollDeg, yawDeg, 90);
    });
  }

  // =====================================================================
  //  NPC
  // =====================================================================
  const npcList=[];const MAX_NPC=8;
  const NPC_COLS=[[200,60,60],[60,60,200],[60,190,70],[200,170,40],[170,60,200],[40,180,180]];

  class NpcCar{
    constructor(x,y,z){
      this.phys=new CarPhysics(x,y,z);
      this.phys.yaw=Math.random()*Math.PI*2;
      this.wayX=x+(Math.random()-.5)*240;this.wayZ=z+(Math.random()-.5)*240;
      const col=NPC_COLS[Math.floor(Math.random()*NPC_COLS.length)];
      const ct=tCar(...col);
      this.ent=new pc.Entity('npc');app.root.addChild(this.ent);
      const bm=new pc.Entity();bm.addComponent('render',{type:'box',material:mat(ct,1,1)});
      bm.setLocalScale(2,.72,4.5);this.ent.addChild(bm);
      const rm=new pc.Entity();rm.addComponent('render',{type:'box',material:mat(ct,1,1)});
      rm.setLocalScale(1.5,.55,2);rm.setLocalPosition(0,.64,.1);this.ent.addChild(rm);
      // NPCタイヤ（ワールド）
      this.wh=[];
      for(let i=0;i<4;i++){
        const we=new pc.Entity();we.addComponent('render',{type:'cylinder',material:tireMat});
        we.setLocalScale(.42,.28,.42);app.root.addChild(we);this.wh.push(we);
      }
    }
    update(dt){
      const dx=this.wayX-this.phys.pos.x,dz=this.wayZ-this.phys.pos.z;
      if(Math.sqrt(dx*dx+dz*dz)<15){this.wayX=this.phys.pos.x+(Math.random()-.5)*240;this.wayZ=this.phys.pos.z+(Math.random()-.5)*240;}
      const tgt=Math.atan2(dx,dz);
      let dy=tgt-this.phys.yaw;
      while(dy>Math.PI)dy-=Math.PI*2;while(dy<-Math.PI)dy+=Math.PI*2;
      this.phys.update(dt,{accel:Math.abs(this.phys.localFwd)<12,brake:false,left:dy>.07,right:dy<-.07,gear:'D'});
      this.ent.setPosition(this.phys.pos);
      const q=new pc.Quat();q.setFromEulerAngles(this.phys.pitch*57.3,-this.phys.yaw*57.3,-this.phys.roll*57.3);
      this.ent.setRotation(q);
      // タイヤ
      const p=this.phys,f=p.fwd(),r=p.rgt();
      WOFF.forEach((off,i)=>{
        const wx=p.pos.x+r.x*off.x+f.x*off.z,wy=p.pos.y+off.y,wz=p.pos.z+r.z*off.x+f.z*off.z;
        this.wh[i].setPosition(wx,wy,wz);
        this.wh[i].setEulerAngles(p.wheelRot*57.3,-p.yaw*57.3,90);
      });
    }
    destroy(){this.ent.destroy();this.wh.forEach(w=>w.destroy());}
  }

  function spawnNpc(x,y,z){if(npcList.length>=MAX_NPC)return;npcList.push(new NpcCar(x,y,z));}
  for(let i=0;i<4;i++)spawnNpc(40+i*22,5,25+i*20);

  // スキッド
  const skids=[];const MAX_SKID=28;const skidMat2=mat(TX.skid,1,1);
  function addSkid(pos,yaw){
    if(skids.length>=MAX_SKID){skids.shift().destroy();}
    const e=new pc.Entity();e.addComponent('render',{type:'plane',material:skidMat2});
    e.setLocalScale(1.3,1,3.2);e.setPosition(pos.x,pos.y+.025,pos.z);
    e.setEulerAngles(0,-yaw*57.3,0);app.root.addChild(e);skids.push(e);
  }

  // =====================================================================
  //  入力
  // =====================================================================
  const inp={accel:false,brake:false,left:false,right:false,gear:'D'};
  const keys={};

  function btn(id,onD,onU){
    const el=$(id);if(!el)return;
    el.addEventListener('pointerdown',e=>{e.preventDefault();onD();el.classList.add('act');});
    el.addEventListener('pointerup',  e=>{e.preventDefault();onU();el.classList.remove('act');});
    el.addEventListener('pointerleave',e=>{onU();el.classList.remove('act');});
  }
  btn('bacc',()=>inp.accel=true, ()=>inp.accel=false);
  btn('bbrk',()=>inp.brake=true, ()=>inp.brake=false);
  btn('blft',()=>inp.left=true,  ()=>inp.left=false);
  btn('brgt',()=>inp.right=true, ()=>inp.right=false);

  function setGear(g){
    inp.gear=g;
    ['bd','br2','bn'].forEach(id=>$(id).classList.remove('act'));
    $({D:'bd',R:'br2',N:'bn'}[g]).classList.add('act');
    $('geardsp').textContent=g;
  }
  $('bd').addEventListener('click', ()=>setGear('D'));
  $('br2').addEventListener('click',()=>setGear('R'));
  $('bn').addEventListener('click', ()=>setGear('N'));
  setGear('D');

  window.addEventListener('keydown',e=>{
    keys[e.code]=true;
    if(e.code==='Digit1')setGear('D');
    if(e.code==='Digit2')setGear('R');
    if(e.code==='Digit3')setGear('N');
  });
  window.addEventListener('keyup',e=>keys[e.code]=false);

  // 音
  let actx=null,engOsc=null,engGain=null,slpGain=null;
  function initAudio(){
    if(actx)return;actx=new(window.AudioContext||window.webkitAudioContext)();
    engOsc=actx.createOscillator();engOsc.type='sawtooth';
    const dist=actx.createWaveShaper(),cv=new Float32Array(256);
    for(let i=0;i<256;i++){const x=(i*2)/256-1;cv[i]=(Math.PI+200)*x/(Math.PI+200*Math.abs(x));}
    dist.curve=cv;engGain=actx.createGain();engGain.gain.value=.06;
    engOsc.connect(dist);dist.connect(engGain);engGain.connect(actx.destination);engOsc.start();
    const bsz=2048,sp=actx.createScriptProcessor(bsz,1,1);
    sp.onaudioprocess=e=>{const o=e.outputBuffer.getChannelData(0);for(let i=0;i<bsz;i++)o[i]=Math.random()*2-1;};
    slpGain=actx.createGain();slpGain.gain.value=0;
    const flt=actx.createBiquadFilter();flt.type='bandpass';flt.frequency.value=900;
    sp.connect(flt);flt.connect(slpGain);slpGain.connect(actx.destination);
  }
  $('c').addEventListener('pointerdown',initAudio,{once:true});
  window.addEventListener('keydown',initAudio,{once:true});

  // ミニマップ
  const mmcv=$('mmcv'),mmctx=mmcv.getContext('2d'),MMS=98;
  function drawMM(px,pz,yaw){
    mmctx.clearRect(0,0,MMS,MMS);mmctx.fillStyle='rgba(0,28,0,.82)';mmctx.fillRect(0,0,MMS,MMS);
    const sc=1.8,cx=MMS/2,cy=MMS/2;
    mmctx.strokeStyle='#555';mmctx.lineWidth=2;
    for(let i=-3;i<=3;i++){
      mmctx.beginPath();mmctx.moveTo(cx+(i*CSIZ-(px%CSIZ))/sc,0);mmctx.lineTo(cx+(i*CSIZ-(px%CSIZ))/sc,MMS);mmctx.stroke();
      mmctx.beginPath();mmctx.moveTo(0,cy+(i*CSIZ-(pz%CSIZ))/sc);mmctx.lineTo(MMS,cy+(i*CSIZ-(pz%CSIZ))/sc);mmctx.stroke();
    }
    npcList.forEach(n=>{
      const dx=(n.phys.pos.x-px)/sc,dz=(n.phys.pos.z-pz)/sc;
      mmctx.fillStyle='#f44';mmctx.fillRect(cx+dx-2,cy+dz-2,4,4);
    });
    mmctx.save();mmctx.translate(cx,cy);mmctx.rotate(-yaw);
    mmctx.fillStyle='#0f0';mmctx.beginPath();mmctx.moveTo(0,-7);mmctx.lineTo(-4,5);mmctx.lineTo(4,5);mmctx.closePath();mmctx.fill();
    mmctx.restore();
  }

  // カメラ
  const smoothCam=new pc.Vec3(0,7,-14);

  // =====================================================================
  //  メインループ
  // =====================================================================
  let lastCX=9999,lastCZ=9999,frame=0;

  app.on('update',dt=>{
    frame++;dt=Math.min(dt,.05);

    // キー
    if(keys['ArrowUp']  ||keys['KeyW'])inp.accel=true; else if(!$('bacc').classList.contains('act'))inp.accel=false;
    if(keys['ArrowDown']||keys['KeyS'])inp.brake=true; else if(!$('bbrk').classList.contains('act'))inp.brake=false;
    if(keys['ArrowLeft']||keys['KeyA'])inp.left=true;  else if(!$('blft').classList.contains('act'))inp.left=false;
    if(keys['ArrowRight']||keys['KeyD'])inp.right=true;else if(!$('brgt').classList.contains('act'))inp.right=false;

    // 物理
    const st=carPhys.update(dt,inp);

    // 車体エンティティ
    carRoot.setPosition(carPhys.pos);
    const q=new pc.Quat();
    q.setFromEulerAngles(carPhys.pitch*57.3,-carPhys.yaw*57.3,-carPhys.roll*57.3);
    carRoot.setRotation(q);

    // タイヤ（ワールド空間）
    updateWheels(carPhys);

    // スキッド
    if((st.slip>.28||st.isBurn)&&carPhys.onGround&&frame%3===0)addSkid(carPhys.pos,carPhys.yaw);

    // NPC
    if(frame%2===0){
      const rm=[];
      npcList.forEach(n=>{
        if(n.phys.pos.distance(carPhys.pos)>320||n.phys.pos.y<-30){rm.push(n);return;}
        n.update(dt*2);
      });
      rm.forEach(n=>{n.destroy();npcList.splice(npcList.indexOf(n),1);});
      if(npcList.length<MAX_NPC&&frame%40===0){
        const a=Math.random()*Math.PI*2,d=90+Math.random()*100;
        spawnNpc(carPhys.pos.x+Math.cos(a)*d,5,carPhys.pos.z+Math.sin(a)*d);
      }
    }

    // チャンク
    const cx=Math.floor(carPhys.pos.x/CSIZ),cz=Math.floor(carPhys.pos.z/CSIZ);
    if(cx!==lastCX||cz!==lastCZ){
      lastCX=cx;lastCZ=cz;
      for(let dx=-RDIST;dx<=RDIST;dx++)for(let dz=-RDIST;dz<=RDIST;dz++)createChunk(cx+dx,cz+dz);
      chunkMap.forEach((_,k)=>{const[a,b]=k.split(',').map(Number);if(Math.abs(a-cx)>RDIST+1||Math.abs(b-cz)>RDIST+1)removeChunk(k);});
    }

    // カメラ（後方追従）
    const cd=13,ch=6;
    const tx=carPhys.pos.x+Math.sin(carPhys.yaw)*cd,tz=carPhys.pos.z+Math.cos(carPhys.yaw)*cd,ty=carPhys.pos.y+ch;
    const ls=Math.min(1,dt*5);
    smoothCam.x+=(tx-smoothCam.x)*ls;smoothCam.y+=(ty-smoothCam.y)*ls*.5;smoothCam.z+=(tz-smoothCam.z)*ls;
    camE.setPosition(smoothCam);camE.lookAt(carPhys.pos.x,carPhys.pos.y+1.2,carPhys.pos.z);

    // 音
    if(actx&&engOsc){
      engOsc.frequency.setTargetAtTime(55+st.rpm/7500*200,actx.currentTime,.08);
      engGain.gain.setTargetAtTime(.04+carPhys.accelIn*.06,actx.currentTime,.06);
      slpGain.gain.setTargetAtTime(st.slip>.28?.06:0,actx.currentTime,.12);
    }

    // 転落リセット
    if(carPhys.pos.y<-30){
      carPhys.pos.set(carPhys.pos.x,getH(carPhys.pos.x,carPhys.pos.z)+4,carPhys.pos.z);
      carPhys.vel.set(0,0,0);carPhys.angVel=0;
    }

    // HUD
    if(frame%2===0){
      $('spd').textContent=Math.abs(Math.floor(st.speedKmh));
      $('rpmbar').style.width=(st.rpm/7500*100)+'%';
      $('ipos').textContent=`POS: ${Math.floor(carPhys.pos.x)}, ${Math.floor(carPhys.pos.z)}`;
      $('ichk').textContent=`CHUNKS: ${chunkMap.size}`;
      $('inpc').textContent=`NPCs: ${npcList.length} | FPS: ${Math.round(1/Math.max(dt,.001))}`;
      drawMM(carPhys.pos.x,carPhys.pos.z,carPhys.yaw);
    }
  });

  // 初期チャンク
  for(let dx=-RDIST;dx<=RDIST;dx++)for(let dz=-RDIST;dz<=RDIST;dz++)createChunk(dx,dz);
  setPg(80,'Building world...');
}
</script>
</body>
</html>

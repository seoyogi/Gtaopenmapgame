<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>STREET RACER</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:Arial,sans-serif}
#c{width:100%;height:100%;display:block;touch-action:none}
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}

/* â”€â”€ ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå³ä¸‹ï¼‰ â”€â”€ */
#spedo{
  position:absolute;bottom:180px;right:12px;
  background:rgba(0,0,0,.78);border:2px solid #f60;
  border-radius:12px;padding:8px 14px;color:#fff;text-align:center;min-width:100px
}
#spd{font-size:34px;font-weight:700;color:#f60;line-height:1}
#sunit{font-size:10px;color:#aaa}
#rpmwrap{width:100%;background:#333;border-radius:4px;height:6px;margin-top:5px}
#rpmbar{height:6px;background:linear-gradient(90deg,#0f0,#ff0,#f00);border-radius:4px;width:0%}
#geardsp{font-size:22px;font-weight:700;color:#fff;margin-top:3px}

/* â”€â”€ ç¸¦ç”»é¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ â”€â”€ */
#ctrl{
  position:absolute;bottom:0;left:0;right:0;height:170px;
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  align-items:center;
  padding:10px 16px;
  pointer-events:auto;
  background:linear-gradient(transparent,rgba(0,0,0,.35));
}
.btn{
  width:64px;height:64px;border-radius:50%;
  border:2.5px solid rgba(255,255,255,.35);background:rgba(0,0,0,.5);
  color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent;
  backdrop-filter:blur(4px);font-weight:700;touch-action:none;
  transition:background .08s,border-color .08s
}
.btn.act{background:rgba(255,102,0,.7);border-color:#f60}
#bacc{width:72px;height:72px;font-size:28px;background:rgba(0,160,0,.5);border-color:#0c0}
#bbrk{background:rgba(160,0,0,.5);border-color:#c00}

/* å·¦ï¼šã‚¹ãƒ†ã‚¢ */
#left-area{display:flex;gap:10px;justify-content:flex-start;align-items:center}
/* ä¸­ï¼šã‚¢ã‚¯ã‚»ãƒ«ãƒ»ãƒ–ãƒ¬ãƒ¼ã‚­ */
#mid-area{display:flex;flex-direction:column;gap:8px;align-items:center}
/* å³ï¼šã‚®ã‚¢ */
#right-area{display:flex;flex-direction:column;gap:5px;align-items:flex-end}
.gbtn{width:46px;height:46px;border-radius:8px;font-size:14px;font-weight:700}

/* â”€â”€ æƒ…å ±è¡¨ç¤º â”€â”€ */
#info{
  position:absolute;top:8px;left:8px;
  background:rgba(0,0,0,.6);border:1px solid #f60;
  border-radius:8px;padding:5px 10px;color:#fff;font-size:11px;line-height:1.5
}
/* â”€â”€ ãƒŸãƒ‹ãƒãƒƒãƒ— â”€â”€ */
#mmap{
  position:absolute;top:8px;right:8px;
  width:100px;height:100px;border:2px solid #f60;
  border-radius:50%;overflow:hidden
}
#mmcv{width:100%;height:100%}

/* â”€â”€ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â”€â”€ */
#loading{
  position:fixed;inset:0;background:#111;
  display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200
}
#loading h1{font-size:40px;color:#f60;letter-spacing:4px;margin-bottom:6px}
#loading p{color:#aaa;font-size:14px;margin-bottom:20px}
#pgwrap{width:260px;background:#222;border-radius:20px;height:6px}
#pgbar{height:6px;background:#f60;border-radius:20px;width:0%;transition:width .25s}
#glb-input-wrap{margin-top:18px;color:#888;font-size:12px;text-align:center}
#glb-input{display:none}
#glb-label{
  display:inline-block;margin-top:6px;padding:7px 18px;
  background:#333;border:1px solid #f60;border-radius:6px;
  color:#f60;cursor:pointer;font-size:13px
}
</style>
</head>
<body>

<div id="loading">
  <h1>STREET RACER</h1>
  <p id="ldmsg">Loading PlayCanvas...</p>
  <div id="pgwrap"><div id="pgbar"></div></div>
  <div id="glb-input-wrap">
    <div>è»Šã®GLBãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆä»»æ„ï¼‰</div>
    <label id="glb-label" for="glb-input">ğŸ“ GLBãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
    <input type="file" id="glb-input" accept=".glb,.gltf">
  </div>
</div>

<canvas id="c"></canvas>

<div id="hud">
  <div id="info">
    <div id="ipos">POS: 0, 0</div>
    <div id="ichk">CHUNKS: 0</div>
    <div id="inpc">NPCs: 0 | FPS: 0</div>
  </div>
  <div id="mmap"><canvas id="mmcv" width="100" height="100"></canvas></div>
  <div id="spedo">
    <div id="spd">0</div>
    <div id="sunit">km/h</div>
    <div id="rpmwrap"><div id="rpmbar"></div></div>
    <div id="geardsp">D</div>
  </div>
  <div id="ctrl">
    <div id="left-area">
      <div class="btn" id="blft">â—€</div>
      <div class="btn" id="brgt">â–¶</div>
    </div>
    <div id="mid-area">
      <div class="btn" id="bacc">â–²</div>
      <div class="btn" id="bbrk">â– </div>
    </div>
    <div id="right-area">
      <div class="btn gbtn" id="bd">D</div>
      <div class="btn gbtn" id="br">R</div>
      <div class="btn gbtn" id="bn">N</div>
    </div>
  </div>
</div>

<script>
// =====================================================================
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =====================================================================
const $=id=>document.getElementById(id);
function setPg(p,$msg){
  $('pgbar').style.width=p+'%';
  if($msg)$('ldmsg').textContent=$msg;
}
function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src;s.onload=res;s.onerror=rej;
    document.head.appendChild(s);
  });
}

// =====================================================================
//  GLBãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä»»æ„ï¼‰
// =====================================================================
let userGlbUrl=null; // objectURL or null
$('glb-input').addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f)return;
  userGlbUrl=URL.createObjectURL(f);
  $('glb-label').textContent='âœ… '+f.name;
});

// =====================================================================
//  MAIN
// =====================================================================
async function main(){
  setPg(10,'Loading PlayCanvas...');
  await loadScript('https://code.playcanvas.com/playcanvas-stable.min.js');
  setPg(60,'Initializing game...');
  // å°‘ã—å¾…ã£ã¦GLBé¸æŠã®çŒ¶äºˆã‚’ä¸ãˆã‚‹
  await new Promise(r=>setTimeout(r,800));
  setPg(90,'Building world...');
  initGame();
}
main().catch(e=>{
  $('loading').innerHTML=`<h2 style="color:red">Error</h2><pre style="color:#f88;font-size:11px">${e.stack||e}</pre>`;
});

// =====================================================================
//  NOISE
// =====================================================================
function n2(x,z,s=1){
  return(Math.sin(x*127.1+s)*43758.5453+Math.sin(z*311.7+s*1.3)*43758.5453)%1;
}
function sn(x,z,sc=0.008){
  const ix=Math.floor(x*sc),iz=Math.floor(z*sc);
  const fx=(x*sc-ix),fz=(z*sc-iz);
  const ux=fx*fx*(3-2*fx),uz=fz*fz*(3-2*fz);
  const a=(n2(ix,iz)+1)%1,b=(n2(ix+1,iz)+1)%1;
  const c=(n2(ix,iz+1)+1)%1,d=(n2(ix+1,iz+1)+1)%1;
  return a*(1-ux)*(1-uz)+b*ux*(1-uz)+c*(1-ux)*uz+d*ux*uz;
}
function getH(x,z){
  // é“è·¯ç¶²ï¼ˆ200mé–“éš”ã‚°ãƒªãƒƒãƒ‰ï¼‰ã¯å¹³å¦
  const mx=((x%200)+200)%200; // 0-200
  const mz=((z%200)+200)%200;
  const distX=Math.min(mx,200-mx);  // é“è·¯ä¸­å¿ƒ0ã‹ã‚‰ã®è·é›¢
  const distZ=Math.min(mz,200-mz);
  const onRoadX=distZ<11; // Zæ–¹å‘ã®é“è·¯ï¼ˆXè»¸å¹³è¡Œï¼‰
  const onRoadZ=distX<11; // Xæ–¹å‘ã®é“è·¯ï¼ˆZè»¸å¹³è¡Œï¼‰
  const roadMask=onRoadX||onRoadZ?1:0;
  const smoothMask=Math.max(
    Math.max(0,1-Math.min(mz,200-mz)/18),
    Math.max(0,1-Math.min(mx,200-mx)/18)
  );
  const h=sn(x,z)*12-2+sn(x,z,0.025)*3;
  return h*(1-smoothMask*.97);
}

// =====================================================================
//  GAME
// =====================================================================
function initGame(){
  const canvas=$('c');
  const app=new pc.Application(canvas,{
    mouse:new pc.Mouse(canvas),
    touch:new pc.TouchDevice(canvas),
    keyboard:new pc.Keyboard(window),
    graphicsDeviceOptions:{antialias:true,alpha:false,powerPreference:'high-performance'}
  });
  app.setCanvasFillMode(pc.FILLMODE_FILL_WINDOW);
  app.setCanvasResolution(pc.RESOLUTION_AUTO);
  app.start();

  // â”€â”€ ãƒ†ã‚¯ã‚¹ãƒãƒ£ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ â”€â”€
  function pcTex(w,h,drawFn,rep=true){
    const cv=document.createElement('canvas');
    cv.width=w;cv.height=h;
    drawFn(cv.getContext('2d'),w,h);
    const t=new pc.Texture(app.graphicsDevice,{
      width:w,height:h,format:pc.PIXELFORMAT_R8_G8_B8_A8,mipmaps:true,
      minFilter:pc.FILTER_LINEAR_MIPMAP_LINEAR,magFilter:pc.FILTER_LINEAR,
      addressU:rep?pc.ADDRESS_REPEAT:pc.ADDRESS_CLAMP_TO_EDGE,
      addressV:rep?pc.ADDRESS_REPEAT:pc.ADDRESS_CLAMP_TO_EDGE
    });
    t.setSource(cv);return t;
  }

  // â”€â”€ ãƒ†ã‚¯ã‚¹ãƒãƒ£å®šç¾© â”€â”€
  // ã‚¢ã‚¹ãƒ•ã‚¡ãƒ«ãƒˆ
  const TX_ASPHALT=pcTex(256,256,(ctx,w,h)=>{
    ctx.fillStyle='#252525';ctx.fillRect(0,0,w,h);
    for(let i=0;i<5000;i++){const v=18+Math.random()*32;ctx.fillStyle=`rgb(${v},${v},${v})`;ctx.fillRect(Math.random()*w,Math.random()*h,2,2);}
    ctx.strokeStyle='#ddbb00';ctx.lineWidth=5;ctx.setLineDash([36,28]);
    ctx.beginPath();ctx.moveTo(w/2,0);ctx.lineTo(w/2,h);ctx.stroke();
    ctx.strokeStyle='#ccc';ctx.lineWidth=2;ctx.setLineDash([16,18]);
    [w/4,3*w/4].forEach(x=>{ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();});
  });
  // ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆåœ°é¢
  const TX_CONCRETE=pcTex(256,256,(ctx,w,h)=>{
    ctx.fillStyle='#888';ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#666';ctx.lineWidth=1.5;
    for(let y=0;y<h;y+=40)for(let x=0;x<w;x+=60)ctx.strokeRect(x+1,y+1,58,38);
    for(let i=0;i<2000;i++){const v=100+Math.random()*40;ctx.globalAlpha=.18;ctx.fillStyle=`rgb(${v},${v},${v})`;ctx.fillRect(Math.random()*w,Math.random()*h,2,2);}
    ctx.globalAlpha=1;
  });
  // ãƒ“ãƒ«å£
  const TX_WALL_A=pcTex(256,512,(ctx,w,h)=>{
    ctx.fillStyle='#7a7a7a';ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#5e5e5e';ctx.lineWidth=1.5;
    for(let y=0;y<h;y+=42){const off=Math.floor(y/42)%2*29;for(let x=-off;x<w;x+=58)ctx.strokeRect(x+1,y+1,56,40);}
    for(let i=0;i<2500;i++){const v=90+Math.random()*40;ctx.globalAlpha=.2;ctx.fillStyle=`rgb(${v},${v},${v})`;ctx.fillRect(Math.random()*w,Math.random()*h,2,2);}
    ctx.globalAlpha=1;
  });
  const TX_WALL_B=pcTex(256,512,(ctx,w,h)=>{
    const g=ctx.createLinearGradient(0,0,w,h);
    g.addColorStop(0,'#152e4a');g.addColorStop(1,'#1c4a72');
    ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
    const ww=34,wh=24,gap=7;
    for(let y=gap;y<h-wh;y+=wh+gap)for(let x=gap;x<w-ww;x+=ww+gap){
      const r=Math.random();
      ctx.fillStyle=r<.55?`rgba(255,235,155,${.22+Math.random()*.52})`:'rgba(28,65,105,.8)';
      ctx.fillRect(x,y,ww-2,wh-2);
      ctx.strokeStyle='rgba(170,205,255,.22)';ctx.lineWidth=1;ctx.strokeRect(x,y,ww-2,wh-2);
    }
  });
  // æ°´é¢
  const TX_WATER=pcTex(256,256,(ctx,w,h)=>{
    const g=ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'#0a3360');g.addColorStop(.5,'#144e8a');g.addColorStop(1,'#0a3f6e');
    ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='rgba(80,160,255,.32)';ctx.lineWidth=1.5;
    for(let i=0;i<9;i++){const y=(i/9)*h;ctx.beginPath();for(let x=0;x<w;x+=4){const wy=y+Math.sin((x/w)*Math.PI*7+i)*5;x===0?ctx.moveTo(x,wy):ctx.lineTo(x,wy);}ctx.stroke();}
    for(let i=0;i<25;i++){ctx.fillStyle='rgba(190,225,255,.22)';ctx.beginPath();ctx.ellipse(Math.random()*w,Math.random()*h,7+Math.random()*20,3,0,0,Math.PI*2);ctx.fill();}
  });
  // å±‹ä¸Š
  const TX_ROOF=pcTex(256,256,(ctx,w,h)=>{
    ctx.fillStyle='#4e4e4e';ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#3a3a3a';ctx.lineWidth=1;
    for(let i=0;i<w;i+=32)ctx.strokeRect(i,0,32,h);
    for(let j=0;j<h;j+=32)ctx.strokeRect(0,j,w,32);
    for(let i=0;i<5;i++){const x=10+Math.random()*(w-60),y=10+Math.random()*(h-40);ctx.fillStyle='#616161';ctx.fillRect(x,y,20+Math.random()*28,11+Math.random()*17);}
  });
  // æ©‹
  const TX_BRIDGE=pcTex(256,256,(ctx,w,h)=>{
    ctx.fillStyle='#787878';ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#636363';ctx.lineWidth=3;
    for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(0,(i/6)*h);ctx.lineTo(w,(i/6)*h);ctx.stroke();}
    ctx.strokeStyle='#575757';ctx.lineWidth=2;
    for(let i=0;i<6;i++){ctx.beginPath();ctx.moveTo(i*w/5,0);ctx.lineTo((i+1)*w/5,h);ctx.stroke();ctx.beginPath();ctx.moveTo((i+1)*w/5,0);ctx.lineTo(i*w/5,h);ctx.stroke();}
    for(let i=0;i<120;i++){ctx.fillStyle=`rgba(108,52,14,${.07+Math.random()*.16})`;ctx.fillRect(Math.random()*w,Math.random()*h,4,4);}
  });
  // ã‚¹ã‚­ãƒƒãƒ‰ãƒãƒ¼ã‚¯
  const TX_SKID=pcTex(64,256,(ctx,w,h)=>{
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='rgba(8,8,8,.8)';ctx.fillRect(4,0,14,h);ctx.fillRect(w-18,0,14,h);
    for(let i=0;i<180;i++){const sx=Math.random()<.5?4+Math.random()*14:w-18+Math.random()*14;ctx.fillStyle=`rgba(0,0,0,${.2+Math.random()*.4})`;ctx.fillRect(sx,Math.random()*h,2,3);}
  });
  // è»Šä½“
  function tCar(r,g,b){
    return pcTex(128,128,(ctx,w,h)=>{
      const gr=ctx.createLinearGradient(0,0,0,h);
      gr.addColorStop(0,`rgb(${Math.min(255,r+60)},${Math.min(255,g+60)},${Math.min(255,b+60)})`);
      gr.addColorStop(.5,`rgb(${r},${g},${b})`);
      gr.addColorStop(1,`rgb(${Math.max(0,r-40)},${Math.max(0,g-40)},${Math.max(0,b-40)})`);
      ctx.fillStyle=gr;ctx.fillRect(0,0,w,h);
      ctx.fillStyle='rgba(255,255,255,.16)';ctx.fillRect(8,4,w-16,16);
    },false);
  }
  // ã‚¿ã‚¤ãƒ¤ã‚µã‚¤ãƒ‰ã‚¦ã‚©ãƒ¼ãƒ«
  const TX_TIRE=pcTex(64,64,(ctx,w,h)=>{
    ctx.fillStyle='#1a1a1a';ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#3a3a3a';ctx.lineWidth=2.5;
    for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2;ctx.beginPath();ctx.moveTo(w/2,h/2);ctx.lineTo(w/2+Math.cos(a)*w/2,h/2+Math.sin(a)*h/2);ctx.stroke();}
    ctx.strokeStyle='#555';ctx.lineWidth=4;ctx.beginPath();ctx.arc(w/2,h/2,w/2-4,0,Math.PI*2);ctx.stroke();
  });

  // â”€â”€ ãƒãƒ†ãƒªã‚¢ãƒ«ãƒ˜ãƒ«ãƒ‘ãƒ¼ â”€â”€
  function mat(tex,tu=1,tv=1,rough=.85){
    const m=new pc.StandardMaterial();
    m.diffuseMap=tex;m.diffuseMapTiling=new pc.Vec2(tu,tv);
    m.roughness=rough;m.metalness=.04;m.update();return m;
  }

  // â”€â”€ ãƒ©ã‚¤ãƒˆ â”€â”€
  const sun=new pc.Entity('sun');
  sun.addComponent('light',{type:'directional',color:new pc.Color(1,.96,.86),intensity:1.6,
    castShadows:true,shadowBias:.2,shadowResolution:1024,shadowRange:100});
  sun.setEulerAngles(45,130,0);app.root.addChild(sun);
  const fill=new pc.Entity('fill');
  fill.addComponent('light',{type:'directional',color:new pc.Color(.3,.5,.7),intensity:.4});
  fill.setEulerAngles(-30,0,0);app.root.addChild(fill);

  // â”€â”€ ã‚«ãƒ¡ãƒ© â”€â”€
  const camE=new pc.Entity('cam');
  camE.addComponent('camera',{fov:65,nearClip:.4,farClip:500,clearColor:new pc.Color(.5,.7,.9)});
  app.root.addChild(camE);

  // =====================================================================
  //  ãƒãƒ£ãƒ³ã‚¯ã‚·ã‚¹ãƒ†ãƒ 
  // =====================================================================
  const CSIZ=200,RDIST=2;
  const chunkMap=new Map();

  function createChunk(cx,cz){
    const k=cx+','+cz;
    if(chunkMap.has(k))return;
    const wx=cx*CSIZ,wz=cz*CSIZ;
    const ents=[];

    // åœ°é¢ãƒ¡ãƒƒã‚·ãƒ¥ï¼ˆã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆï¼‹é“è·¯ã§æ§‹æˆï¼‰
    {
      const segs=14,step=CSIZ/segs;
      const pos=[],uvs=[],norms=[],inds=[];
      for(let zi=0;zi<=segs;zi++)for(let xi=0;xi<=segs;xi++){
        const lx=xi*step,lz=zi*step;
        const h=getH(wx+lx,wz+lz);
        pos.push(lx-CSIZ/2,h,lz-CSIZ/2);
        uvs.push(xi/segs*6,zi/segs*6);norms.push(0,1,0);
      }
      for(let zi=0;zi<segs;zi++)for(let xi=0;xi<segs;xi++){
        const i=zi*(segs+1)+xi;
        inds.push(i,i+segs+1,i+1,i+1,i+segs+1,i+segs+2);
      }
      // æ³•ç·š
      for(let i=0;i<inds.length;i+=3){
        const i0=inds[i]*3,i1=inds[i+1]*3,i2=inds[i+2]*3;
        const ax=pos[i1]-pos[i0],ay=pos[i1+1]-pos[i0+1],az=pos[i1+2]-pos[i0+2];
        const bx=pos[i2]-pos[i0],by=pos[i2+1]-pos[i0+1],bz=pos[i2+2]-pos[i0+2];
        const nx=ay*bz-az*by,ny=az*bx-ax*bz,nz=ax*by-ay*bx;
        const ln=Math.sqrt(nx*nx+ny*ny+nz*nz)+.001;
        for(let j=0;j<3;j++){const ii=inds[i+j];norms[ii*3]+=nx/ln;norms[ii*3+1]+=ny/ln;norms[ii*3+2]+=nz/ln;}
      }
      const mesh=new pc.Mesh(app.graphicsDevice);
      mesh.setPositions(pos);mesh.setNormals(norms);mesh.setUvs(0,uvs);mesh.setIndices(inds);mesh.update();
      const ge=new pc.Entity('gnd_'+k);
      ge.addComponent('render',{meshInstances:[new pc.MeshInstance(mesh,mat(TX_CONCRETE,6,6))]});
      ge.setPosition(wx+CSIZ/2,0,wz+CSIZ/2);
      app.root.addChild(ge);ents.push(ge);
    }

    const rng=s=>(Math.sin(cx*1637+cz*311+s)*.5+.5);

    // é“è·¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆXæ–¹å‘ï¼‰
    {
      const h=getH(wx+CSIZ/2,wz+CSIZ/2);
      const e=new pc.Entity();e.addComponent('render',{type:'plane',material:mat(TX_ASPHALT,8,1)});
      e.setLocalScale(CSIZ,1,22);e.setPosition(wx+CSIZ/2,h+.06,wz+CSIZ/2);
      app.root.addChild(e);ents.push(e);
    }
    // é“è·¯ï¼ˆZæ–¹å‘ï¼‰
    {
      const h=getH(wx+CSIZ/2,wz+CSIZ/2);
      const e=new pc.Entity();e.addComponent('render',{type:'plane',material:mat(TX_ASPHALT,1,8)});
      e.setLocalScale(22,1,CSIZ);e.setPosition(wx+CSIZ/2,h+.06,wz+CSIZ/2);
      app.root.addChild(e);ents.push(e);
    }

    // å·
    if(rng(0)>.58){
      const rvx=wx+CSIZ*.2+rng(1)*CSIZ*.15;
      const rvy=getH(rvx,wz+CSIZ/2)-.25;
      const rvw=20+rng(2)*16;
      const rv=new pc.Entity();rv.addComponent('render',{type:'plane',material:mat(TX_WATER,3,7)});
      rv.setLocalScale(rvw,1,CSIZ);rv.setPosition(rvx,rvy,wz+CSIZ/2);
      app.root.addChild(rv);ents.push(rv);
      // æ©‹
      const bh=Math.max(getH(rvx,wz+CSIZ/2),rvy)+.55;
      const br=new pc.Entity();br.addComponent('render',{type:'box',material:mat(TX_BRIDGE,2,1)});
      br.setLocalScale(rvw+5,1.1,24);br.setPosition(rvx,bh,wz+CSIZ/2);
      app.root.addChild(br);ents.push(br);
    }

    // ãƒ“ãƒ«
    const nb=Math.floor(2+rng(10)*5);
    for(let bi=0;bi<nb;bi++){
      const bx=wx+rng(bi*7+1)*CSIZ,bz=wz+rng(bi*7+2)*CSIZ;
      if(Math.abs(bz-(wz+CSIZ/2))<22||Math.abs(bx-(wx+CSIZ/2))<22)continue;
      const bw=12+rng(bi*7+3)*20,bd=12+rng(bi*7+4)*20,bh=16+rng(bi*7+5)*85;
      const gh=getH(bx,bz);
      const wm=mat(rng(bi*7+6)>.45?TX_WALL_B:TX_WALL_A,1,bh/18);
      const be=new pc.Entity();be.addComponent('render',{type:'box',material:wm});
      be.setLocalScale(bw,bh,bd);be.setPosition(bx,gh+bh/2,bz);be.setEulerAngles(0,rng(bi*7+7)*12-6,0);
      app.root.addChild(be);ents.push(be);
      const rf=new pc.Entity();rf.addComponent('render',{type:'box',material:mat(TX_ROOF)});
      rf.setLocalScale(bw,.4,bd);rf.setPosition(bx,gh+bh+.2,bz);
      app.root.addChild(rf);ents.push(rf);
    }

    chunkMap.set(k,ents);
  }

  function removeChunk(k){
    const ents=chunkMap.get(k);if(!ents)return;
    ents.forEach(e=>e.destroy());chunkMap.delete(k);
  }

  // =====================================================================
  //  ã‚«ãƒ¼ç‰©ç†
  //  â€» yaw=0 ã®ã¨ãå‰æ–¹ã¯ +Z æ–¹å‘ï¼ˆPlayCanvasæ¨™æº–ï¼‰
  //  â€» forward = (sin(yaw), 0, cos(yaw))  â†’ yawå¢—åŠ ã§å³æ—‹å›
  // =====================================================================
  class CarPhysics{
    constructor(x,y,z){
      this.pos=new pc.Vec3(x,y,z);
      this.vel=new pc.Vec3(0,0,0);
      this.yaw=0;          // ãƒ©ã‚¸ã‚¢ãƒ³ã€‚0=+Zæ–¹å‘ãŒå‰
      this.pitch=0;this.roll=0;
      this.angVel=0;       // ãƒ¨ãƒ¼è§’é€Ÿåº¦ rad/s

      this.mass=1400;
      this.wheelBase=2.8;
      this.trackWidth=1.8;

      this.rpm=800;
      this.accelInput=0;
      this.brakeInput=0;
      this.steer=0;        // ã‚¹ãƒ†ã‚¢è§’ radï¼ˆæ­£=å·¦æ—‹å›ï¼‰
      this.slip=0;
      this.onGround=false;
      this.localFwd=0;     // ãƒ­ãƒ¼ã‚«ãƒ«å‰å¾Œé€Ÿåº¦ï¼ˆæ­£=å‰é€²ï¼‰
      this.localSide=0;    // ãƒ­ãƒ¼ã‚«ãƒ«å·¦å³é€Ÿåº¦
      this.wheelRot=0;     // ãƒ›ã‚¤ãƒ¼ãƒ«å›è»¢è§’ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    }

    // å‰æ–¹ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ+ZåŸºæº–ï¼‰
    fwdVec(){return{x:Math.sin(this.yaw),z:Math.cos(this.yaw)};}
    // å³æ–¹ãƒ™ã‚¯ãƒˆãƒ«
    rgtVec(){return{x:Math.cos(this.yaw),z:-Math.sin(this.yaw)};}

    update(dt,inp){
      const{accel,brake,left,right,gear}=inp;

      // â”€â”€ å…¥åŠ›å¹³æ»‘åŒ– â”€â”€
      this.accelInput+=(( accel?1:0)-this.accelInput)*Math.min(1,dt*(accel?2.5:5));
      this.brakeInput+=((brake?1:0)-this.brakeInput)*Math.min(1,dt*(brake?7:9));
      const steerTgt=(left?1:right?-1:0)*Math.max(.28,1-Math.abs(this.localFwd)/50);
      this.steer+=(steerTgt-this.steer)*Math.min(1,dt*7);

      // â”€â”€ 4è¼ªåœ°å½¢ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° â”€â”€
      const f=this.fwdVec(),r=this.rgtVec();
      const hw=this.wheelBase/2,ht=this.trackWidth/2;
      const wpos=[
        {x:this.pos.x+r.x*ht+f.x*hw, z:this.pos.z+r.z*ht+f.z*hw},  // FL
        {x:this.pos.x-r.x*ht+f.x*hw, z:this.pos.z-r.z*ht+f.z*hw},  // FR
        {x:this.pos.x+r.x*ht-f.x*hw, z:this.pos.z+r.z*ht-f.z*hw},  // RL
        {x:this.pos.x-r.x*ht-f.x*hw, z:this.pos.z-r.z*ht-f.z*hw},  // RR
      ];
      const gh=wpos.map(p=>getH(p.x,p.z));

      // â”€â”€ ã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³ â”€â”€
      const REST=0.42;
      let netFy=-this.mass*13; // é‡åŠ›
      this.onGround=false;
      for(let i=0;i<4;i++){
        const pen=gh[i]+REST-this.pos.y;
        if(pen>0){this.onGround=true;netFy+=52000*pen-3000*this.vel.y;}
      }

      // â”€â”€ ãƒ­ãƒ¼ã‚«ãƒ«é€Ÿåº¦åˆ†è§£ â”€â”€
      this.localFwd =this.vel.x*f.x+this.vel.z*f.z;
      this.localSide=this.vel.x*r.x+this.vel.z*r.z;

      // â”€â”€ é§†å‹•åŠ› â”€â”€
      const MAX_SPD=52;
      let drive=0;
      if(gear==='D'){
        // D=å‰é€²ï¼ˆlocalFwdæ­£æ–¹å‘ï¼‰
        drive= this.accelInput*4800*Math.max(0,1-this.localFwd/MAX_SPD);
        if(this.localFwd<0) drive+=this.accelInput*2500; // é€†èµ°ã‹ã‚‰ã®å›å¾©
      } else if(gear==='R'){
        // R=å¾Œé€€ï¼ˆlocalFwdè² æ–¹å‘ï¼‰
        drive=-this.accelInput*2200*Math.max(0,1+this.localFwd/18);
      }
      // N=é§†å‹•åŠ›0

      // â”€â”€ RPM â”€â”€
      const gi=Math.min(Math.floor(Math.abs(this.localFwd)/8),5);
      const grs=[4,3.2,2.2,1.6,1.2,1.0];
      this.rpm=Math.min(7500,800+this.accelInput*2800+Math.abs(this.localFwd)*grs[gi]*170);

      // â”€â”€ æ‘©æ“¦ â”€â”€
      const isBurn=accel&&brake&&Math.abs(this.localFwd)<3&&gear==='D';
      const fricFwd=this.onGround?(this.brakeInput>.08?(700+this.brakeInput*3800):100):15;
      const fricLat=this.onGround?(isBurn?250:2600):40;
      this.slip=Math.min(1,Math.abs(this.localSide)/(Math.abs(this.localFwd)+1));
      if(isBurn)this.slip=1;
      const rearLat=Math.max(80,2600-Math.abs(this.localFwd)*22);
      const latF=-(isBurn?this.localSide*200:this.localSide*(this.slip>.28?rearLat:fricLat));
      const fwdF=drive-this.localFwd*fricFwd;

      // â”€â”€ ãƒ¨ãƒ¼ â”€â”€
      if(this.onGround&&Math.abs(this.localFwd)>.5){
        const turnRate=Math.tan(this.steer)*this.localFwd/this.wheelBase;
        this.angVel+=(turnRate-this.angVel)*Math.min(1,dt*9);
      }
      if(this.slip>.22&&this.onGround) this.angVel+=this.localSide*.005;
      this.angVel*=Math.max(0,1-dt*(this.onGround?4.5:1));
      this.yaw+=this.angVel*dt;

      // â”€â”€ åŠ›â†’åŠ é€Ÿ â”€â”€
      if(this.onGround){
        const ax=(f.x*fwdF+r.x*latF)/this.mass;
        const az=(f.z*fwdF+r.z*latF)/this.mass;
        this.vel.x+=ax*dt; this.vel.z+=az*dt;
        const spd=Math.sqrt(this.vel.x*this.vel.x+this.vel.z*this.vel.z);
        if(spd>MAX_SPD){this.vel.x*=MAX_SPD/spd;this.vel.z*=MAX_SPD/spd;}
        this.vel.y+=netFy/this.mass*dt;
        this.vel.y*=.65;
      } else {
        this.vel.y-=14*dt;
      }

      this.pos.x+=this.vel.x*dt;
      this.pos.y+=this.vel.y*dt;
      this.pos.z+=this.vel.z*dt;

      // åœ°é¢è²«é€šé˜²æ­¢
      const mh=getH(this.pos.x,this.pos.z);
      if(this.pos.y<mh+.12){this.pos.y=mh+.12;if(this.vel.y<0)this.vel.y=0;}

      // ãƒ”ãƒƒãƒãƒ»ãƒ­ãƒ¼ãƒ«ï¼ˆè¦–è¦šï¼‰
      const af=(gh[0]+gh[1])/2,ar=(gh[2]+gh[3])/2;
      const al=(gh[0]+gh[2])/2,arv=(gh[1]+gh[3])/2;
      this.pitch+=(Math.atan2(ar-af,this.wheelBase)*.85-this.pitch)*Math.min(1,dt*6);
      this.roll +=(Math.atan2(arv-al,this.trackWidth)*.6-this.roll)*Math.min(1,dt*6);

      // ãƒ›ã‚¤ãƒ¼ãƒ«å›è»¢ï¼ˆå‰é€²æ™‚+ã€å¾Œé€€æ™‚-ï¼‰
      this.wheelRot+=this.localFwd*dt*2.2;

      return{slip:this.slip,speedKmh:this.localFwd*3.6,rpm:this.rpm,onGround:this.onGround,isBurn};
    }
  }

  // =====================================================================
  //  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è»Šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ§‹ç¯‰
  // =====================================================================
  const CAR_COLORS=[[210,40,40],[40,90,210],[40,170,70],[210,170,40],[160,40,210],[40,190,190]];
  const pCol=CAR_COLORS[Math.floor(Math.random()*CAR_COLORS.length)];
  const playerCarTex=tCar(...pCol);
  const tireMat=mat(TX_TIRE);

  const carRoot=new pc.Entity('carRoot');
  app.root.addChild(carRoot);

  // ã‚¿ã‚¤ãƒ¤ã¯ carRoot ã®å¤–ï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰ç©ºé–“ã§ä½ç½®æ›´æ–°ï¼‰
  // â†’ carRoot ã®å›è»¢ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹
  const wheelEnts=[];
  for(let i=0;i<4;i++){
    const we=new pc.Entity('whl'+i);
    we.addComponent('render',{type:'cylinder',material:tireMat});
    we.setLocalScale(.46,.3,.46);
    app.root.addChild(we);  // carRootã®å­ã«ã—ãªã„
    wheelEnts.push(we);
  }

  // GLBãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿ã€ãªã‘ã‚Œã°ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ«ãƒ¢ãƒ‡ãƒ«
  let hasGlb=false;

  function buildProceduralCar(){
    // ãƒœãƒ‡ã‚£
    const bm=new pc.Entity('bd');bm.addComponent('render',{type:'box',material:mat(playerCarTex,1,1)});
    bm.setLocalScale(2,.72,4.5);carRoot.addChild(bm);
    // ãƒ«ãƒ¼ãƒ•
    const rm=new pc.Entity('rf');rm.addComponent('render',{type:'box',material:mat(playerCarTex,1,1)});
    rm.setLocalScale(1.5,.55,2.0);rm.setLocalPosition(0,.64,.1);carRoot.addChild(rm);
    // ãƒ•ãƒ­ãƒ³ãƒˆãƒãƒ³ãƒ‘ãƒ¼
    const fb=new pc.Entity('fb');fb.addComponent('render',{type:'box',material:mat(TX_CONCRETE,1,1)});
    fb.setLocalScale(2,.18,.3);fb.setLocalPosition(0,-.28,-2.26);carRoot.addChild(fb);
    // ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒˆ
    const hlM=new pc.StandardMaterial();hlM.emissive=new pc.Color(1,1,.82);hlM.emissiveIntensity=1.3;hlM.update();
    [[-0.68,-.04,-2.3],[0.68,-.04,-2.3]].forEach(p=>{
      const h=new pc.Entity();h.addComponent('render',{type:'box',material:hlM});
      h.setLocalScale(.42,.18,.07);h.setLocalPosition(...p);carRoot.addChild(h);
    });
    // ãƒ†ãƒ¼ãƒ«ãƒ©ã‚¤ãƒˆ
    const tlM=new pc.StandardMaterial();tlM.emissive=new pc.Color(.9,.08,.08);tlM.emissiveIntensity=1.1;tlM.update();
    [[-0.68,-.04,2.3],[0.68,-.04,2.3]].forEach(p=>{
      const t=new pc.Entity();t.addComponent('render',{type:'box',material:tlM});
      t.setLocalScale(.38,.16,.06);t.setLocalPosition(...p);carRoot.addChild(t);
    });
  }

  if(userGlbUrl){
    // GLBãƒ¢ãƒ‡ãƒ«ã‚’PlayCanvas Assetã¨ã—ã¦èª­ã¿è¾¼ã‚€
    const asset=new pc.Asset('car_glb','container',{url:userGlbUrl});
    app.assets.add(asset);
    asset.on('load',()=>{
      const res=asset.resource;
      if(res&&res.instantiateRenderEntity){
        const glbEntity=res.instantiateRenderEntity();
        // ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ï¼ˆGLBã«ã‚ˆã£ã¦ç•°ãªã‚‹ã®ã§é©åº¦ã«ï¼‰
        glbEntity.setLocalScale(1,1,1);
        carRoot.addChild(glbEntity);
        hasGlb=true;
        setPg(100,'Ready!');
        setTimeout(()=>$('loading').style.display='none',300);
      } else {
        buildProceduralCar();
        setPg(100,'Ready!');
        setTimeout(()=>$('loading').style.display='none',300);
      }
    });
    asset.on('error',()=>{
      buildProceduralCar();
      setPg(100,'Ready (GLB load failed)');
      setTimeout(()=>$('loading').style.display='none',400);
    });
    app.assets.load(asset);
  } else {
    buildProceduralCar();
    setPg(100,'Ready!');
    setTimeout(()=>$('loading').style.display='none',300);
  }

  const carPhys=new CarPhysics(0,5,0);

  // ã‚¿ã‚¤ãƒ¤ä½ç½®ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
  // [å³+å·¦-, ç¸¦offset, å‰+å¾Œ-]  â€» carRootãƒ­ãƒ¼ã‚«ãƒ«
  const WHEEL_OFFSETS=[
    { x:-1.06, y:-.3, z:-1.32},  // FL
    { x: 1.06, y:-.3, z:-1.32},  // FR
    { x:-1.06, y:-.3, z: 1.32},  // RL
    { x: 1.06, y:-.3, z: 1.32},  // RR
  ];

  // =====================================================================
  //  NPC
  // =====================================================================
  const npcList=[];
  const MAX_NPC=8;
  const NPC_COLORS=[[200,60,60],[60,60,200],[60,190,70],[200,170,40],[170,60,200],[40,180,180],[200,130,40]];

  class NpcCar{
    constructor(x,y,z){
      this.phys=new CarPhysics(x,y,z);
      this.phys.yaw=Math.random()*Math.PI*2;
      this.wayX=x+(Math.random()-.5)*240;
      this.wayZ=z+(Math.random()-.5)*240;
      const col=NPC_COLORS[Math.floor(Math.random()*NPC_COLORS.length)];
      this.ent=new pc.Entity('npc');app.root.addChild(this.ent);
      const ct=tCar(...col);
      const bm=new pc.Entity();bm.addComponent('render',{type:'box',material:mat(ct,1,1)});
      bm.setLocalScale(2,.72,4.5);this.ent.addChild(bm);
      const rm=new pc.Entity();rm.addComponent('render',{type:'box',material:mat(ct,1,1)});
      rm.setLocalScale(1.5,.55,2.0);rm.setLocalPosition(0,.64,.1);this.ent.addChild(rm);
      // NPCç”¨ã‚¿ã‚¤ãƒ¤ã‚‚ãƒ¯ãƒ¼ãƒ«ãƒ‰ç©ºé–“ã§ç®¡ç†
      this.wheels=[];
      for(let i=0;i<4;i++){
        const we=new pc.Entity();we.addComponent('render',{type:'cylinder',material:tireMat});
        we.setLocalScale(.44,.28,.44);app.root.addChild(we);this.wheels.push(we);
      }
    }

    update(dt){
      const dx=this.wayX-this.phys.pos.x,dz=this.wayZ-this.phys.pos.z;
      const d=Math.sqrt(dx*dx+dz*dz);
      if(d<15){this.wayX=this.phys.pos.x+(Math.random()-.5)*240;this.wayZ=this.phys.pos.z+(Math.random()-.5)*240;}
      const tgt=Math.atan2(dx,dz);
      let dy=tgt-this.phys.yaw;
      while(dy>Math.PI)dy-=Math.PI*2;while(dy<-Math.PI)dy+=Math.PI*2;
      const ai={accel:Math.abs(this.phys.localFwd)<12,brake:false,left:dy>.06,right:dy<-.06,gear:'D'};
      this.phys.update(dt,ai);
      this.ent.setPosition(this.phys.pos);
      const q=new pc.Quat();
      q.setFromEulerAngles(this.phys.pitch*57.3,-this.phys.yaw*57.3,-this.phys.roll*57.3);
      this.ent.setRotation(q);
      // ã‚¿ã‚¤ãƒ¤ä½ç½®æ›´æ–°
      this._updateWheels();
    }

    _updateWheels(){
      const p=this.phys;
      const f=p.fwdVec(),r=p.rgtVec();
      WHEEL_OFFSETS.forEach((off,i)=>{
        const wx=p.pos.x+r.x*off.x+f.x*off.z;
        const wz=p.pos.z+r.z*off.x+f.z*off.z;
        const wy=p.pos.y+off.y;
        this.wheels[i].setPosition(wx,wy,wz);
        // è»Šä½“ãƒ¨ãƒ¼ã«åˆã‚ã›ã¦å›è»¢ï¼ˆã‚¿ã‚¤ãƒ¤ã¯æ¨ªå‘ãcylinderâ†’Zè»¸90åº¦+ãƒ¨ãƒ¼ï¼‰
        const q=new pc.Quat();
        q.setFromEulerAngles(p.wheelRot*57.3, -p.yaw*57.3, 90);
        this.wheels[i].setRotation(q);
      });
    }

    destroy(){
      this.ent.destroy();
      this.wheels.forEach(w=>w.destroy());
    }
  }

  function spawnNpc(x,y,z){if(npcList.length>=MAX_NPC)return;npcList.push(new NpcCar(x,y,z));}
  for(let i=0;i<4;i++)spawnNpc(40+i*22,5,25+i*20);

  // =====================================================================
  //  ã‚¹ã‚­ãƒƒãƒ‰ãƒãƒ¼ã‚¯
  // =====================================================================
  const skids=[];const MAX_SKID=30;const skidMat2=mat(TX_SKID,1,1);
  function addSkid(pos,yaw){
    if(skids.length>=MAX_SKID){const o=skids.shift();o.destroy();}
    const e=new pc.Entity();e.addComponent('render',{type:'plane',material:skidMat2});
    e.setLocalScale(1.3,1,3.2);e.setPosition(pos.x,pos.y+.025,pos.z);
    e.setEulerAngles(0,-yaw*57.3,0);app.root.addChild(e);skids.push(e);
  }

  // =====================================================================
  //  å…¥åŠ›
  // =====================================================================
  const inp={accel:false,brake:false,left:false,right:false,gear:'D'};
  const keys={};

  function setupBtn(id,onD,onU){
    const el=$(id);if(!el)return;
    el.addEventListener('pointerdown',e=>{e.preventDefault();onD();el.classList.add('act');});
    el.addEventListener('pointerup',e=>{e.preventDefault();onU();el.classList.remove('act');});
    el.addEventListener('pointerleave',e=>{onU();el.classList.remove('act');});
  }
  setupBtn('bacc',()=>inp.accel=true,()=>inp.accel=false);
  setupBtn('bbrk',()=>inp.brake=true,()=>inp.brake=false);
  setupBtn('blft',()=>inp.left=true, ()=>inp.left=false);
  setupBtn('brgt',()=>inp.right=true,()=>inp.right=false);

  function setGear(g){
    inp.gear=g;
    ['bd','br','bn'].forEach(id=>$(id).classList.remove('act'));
    $({D:'bd',R:'br',N:'bn'}[g]).classList.add('act');
    $('geardsp').textContent=g;
  }
  $('bd').addEventListener('click',()=>setGear('D'));
  $('br').addEventListener('click',()=>setGear('R'));
  $('bn').addEventListener('click',()=>setGear('N'));
  setGear('D');

  window.addEventListener('keydown',e=>{
    keys[e.code]=true;
    if(e.code==='Digit1')setGear('D');
    if(e.code==='Digit2')setGear('R');
    if(e.code==='Digit3')setGear('N');
  });
  window.addEventListener('keyup',e=>keys[e.code]=false);

  // =====================================================================
  //  éŸ³å£°
  // =====================================================================
  let actx=null,engOsc=null,engGain=null,slpGain=null;
  function initAudio(){
    if(actx)return;
    actx=new(window.AudioContext||window.webkitAudioContext)();
    engOsc=actx.createOscillator();engOsc.type='sawtooth';
    const dist=actx.createWaveShaper();
    const cv=new Float32Array(256);
    for(let i=0;i<256;i++){const x=(i*2)/256-1;cv[i]=(Math.PI+200)*x/(Math.PI+200*Math.abs(x));}
    dist.curve=cv;
    engGain=actx.createGain();engGain.gain.value=.06;
    engOsc.connect(dist);dist.connect(engGain);engGain.connect(actx.destination);engOsc.start();
    const bsz=2048,spn=actx.createScriptProcessor(bsz,1,1);
    spn.onaudioprocess=e=>{const o=e.outputBuffer.getChannelData(0);for(let i=0;i<bsz;i++)o[i]=(Math.random()*2-1);};
    slpGain=actx.createGain();slpGain.gain.value=0;
    const flt=actx.createBiquadFilter();flt.type='bandpass';flt.frequency.value=900;
    spn.connect(flt);flt.connect(slpGain);slpGain.connect(actx.destination);
  }
  $('c').addEventListener('pointerdown',initAudio,{once:true});
  window.addEventListener('keydown',initAudio,{once:true});

  // =====================================================================
  //  ãƒŸãƒ‹ãƒãƒƒãƒ—
  // =====================================================================
  const mmcv=$('mmcv'),mmctx=mmcv.getContext('2d'),MMS=100;
  function drawMM(px,pz,yaw){
    mmctx.clearRect(0,0,MMS,MMS);
    mmctx.fillStyle='rgba(0,30,0,.82)';mmctx.fillRect(0,0,MMS,MMS);
    const sc=1.8,cx=MMS/2,cy=MMS/2;
    mmctx.strokeStyle='#555';mmctx.lineWidth=2.5;
    for(let i=-3;i<=3;i++){
      const rx=cx+(i*CSIZ-(px%CSIZ))/sc;
      mmctx.beginPath();mmctx.moveTo(rx,0);mmctx.lineTo(rx,MMS);mmctx.stroke();
      const rz=cy+(i*CSIZ-(pz%CSIZ))/sc;
      mmctx.beginPath();mmctx.moveTo(0,rz);mmctx.lineTo(MMS,rz);mmctx.stroke();
    }
    npcList.forEach(n=>{
      const dx=(n.phys.pos.x-px)/sc,dz=(n.phys.pos.z-pz)/sc;
      mmctx.fillStyle='#f44';mmctx.fillRect(cx+dx-2,cy+dz-2,4,4);
    });
    mmctx.save();mmctx.translate(cx,cy);mmctx.rotate(-yaw);
    mmctx.fillStyle='#0f0';mmctx.beginPath();mmctx.moveTo(0,-7);mmctx.lineTo(-4,5);mmctx.lineTo(4,5);
    mmctx.closePath();mmctx.fill();mmctx.restore();
  }

  // =====================================================================
  //  ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ã‚¤ãƒ¤ä½ç½®æ›´æ–°ï¼ˆcarRootã®å¤–ã§ãƒ¯ãƒ¼ãƒ«ãƒ‰ç©ºé–“ï¼‰
  // =====================================================================
  function updatePlayerWheels(){
    const p=carPhys;
    const f=p.fwdVec(),r=p.rgtVec();
    WHEEL_OFFSETS.forEach((off,i)=>{
      // carRootãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›
      // off.x=å³æ–¹å‘ã‚ªãƒ•ã‚»ãƒƒãƒˆ, off.z=å‰å¾Œã‚ªãƒ•ã‚»ãƒƒãƒˆ, off.y=é«˜ã•
      const wx=p.pos.x + r.x*off.x + f.x*off.z;
      const wz=p.pos.z + r.z*off.x + f.z*off.z;
      const wy=p.pos.y + off.y;
      wheelEnts[i].setPosition(wx, wy, wz);
      // ã‚¿ã‚¤ãƒ¤å‘ãï¼šè»Šä½“ãƒ¨ãƒ¼ + å‰é€²æ–¹å‘ã®å›è»¢
      // cylinder ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆYè»¸æ–¹å‘ã€setLocalEulerAngles(rot, yaw_deg, 90) ã§æ¨ªå‘ã
      const q=new pc.Quat();
      // X=è»¢ãŒã‚Šè§’åº¦ã€Y=ãƒ¨ãƒ¼ï¼ˆè»Šä½“æ–¹å‘ï¼‰ã€Z=90åº¦ã§cylinderã‚’æ¨ªå‘ã
      q.setFromEulerAngles(p.wheelRot*57.3, -p.yaw*57.3, 90);
      wheelEnts[i].setRotation(q);
    });
  }

  // =====================================================================
  //  ã‚«ãƒ¡ãƒ©
  // =====================================================================
  const smoothCam=new pc.Vec3(0,7,-14);
  const CAM_LAG=5;

  // =====================================================================
  //  ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
  // =====================================================================
  let lastCX=9999,lastCZ=9999,frame=0;

  app.on('update',dt=>{
    frame++;
    dt=Math.min(dt,.05);

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ â†’ inpåæ˜ 
    const kA=keys['ArrowUp']||keys['KeyW'];
    const kB=keys['ArrowDown']||keys['KeyS'];
    const kL=keys['ArrowLeft']||keys['KeyA'];
    const kR=keys['ArrowRight']||keys['KeyD'];
    if(kA)inp.accel=true; else if(!$('bacc').classList.contains('act'))inp.accel=false;
    if(kB)inp.brake=true; else if(!$('bbrk').classList.contains('act'))inp.brake=false;
    if(kL)inp.left=true;  else if(!$('blft').classList.contains('act'))inp.left=false;
    if(kR)inp.right=true; else if(!$('brgt').classList.contains('act'))inp.right=false;

    // ç‰©ç†æ›´æ–°
    const st=carPhys.update(dt,inp);

    // carRootæ›´æ–°
    carRoot.setPosition(carPhys.pos);
    const q=new pc.Quat();
    q.setFromEulerAngles(carPhys.pitch*57.3, -carPhys.yaw*57.3, -carPhys.roll*57.3);
    carRoot.setRotation(q);

    // ã‚¿ã‚¤ãƒ¤æ›´æ–°ï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰ç©ºé–“ï¼‰
    updatePlayerWheels();

    // ã‚¹ã‚­ãƒƒãƒ‰ãƒãƒ¼ã‚¯
    if((st.slip>.28||st.isBurn)&&carPhys.onGround&&frame%3===0)
      addSkid(carPhys.pos,carPhys.yaw);

    // NPC
    if(frame%2===0){
      const rm=[];
      npcList.forEach(n=>{
        if(n.phys.pos.distance(carPhys.pos)>320||n.phys.pos.y<-30){rm.push(n);return;}
        n.update(dt*2);
      });
      rm.forEach(n=>{n.destroy();npcList.splice(npcList.indexOf(n),1);});
      if(npcList.length<MAX_NPC&&frame%40===0){
        const a=Math.random()*Math.PI*2,d=90+Math.random()*100;
        const sx=carPhys.pos.x+Math.cos(a)*d,sz=carPhys.pos.z+Math.sin(a)*d;
        spawnNpc(sx,getH(sx,sz)+2,sz);
      }
    }

    // ãƒãƒ£ãƒ³ã‚¯ç®¡ç†
    const cx=Math.floor(carPhys.pos.x/CSIZ),cz=Math.floor(carPhys.pos.z/CSIZ);
    if(cx!==lastCX||cz!==lastCZ){
      lastCX=cx;lastCZ=cz;
      for(let dx=-RDIST;dx<=RDIST;dx++)for(let dz=-RDIST;dz<=RDIST;dz++)createChunk(cx+dx,cz+dz);
      chunkMap.forEach((_,k)=>{
        const[kcx,kcz]=k.split(',').map(Number);
        if(Math.abs(kcx-cx)>RDIST+1||Math.abs(kcz-cz)>RDIST+1)removeChunk(k);
      });
    }

    // ã‚«ãƒ¡ãƒ©ï¼ˆå¾Œæ–¹è¿½å¾“ï¼‰
    const camDist=13,camH=6;
    const tx=carPhys.pos.x+Math.sin(carPhys.yaw)*camDist;
    const tz=carPhys.pos.z+Math.cos(carPhys.yaw)*camDist;
    const ty=carPhys.pos.y+camH;
    const ls=Math.min(1,dt*CAM_LAG);
    smoothCam.x+=(tx-smoothCam.x)*ls;
    smoothCam.y+=(ty-smoothCam.y)*ls*.55;
    smoothCam.z+=(tz-smoothCam.z)*ls;
    camE.setPosition(smoothCam);
    camE.lookAt(carPhys.pos.x,carPhys.pos.y+1.2,carPhys.pos.z);

    // éŸ³
    if(actx&&engOsc){
      engOsc.frequency.setTargetAtTime(55+st.rpm/7500*200,actx.currentTime,.08);
      engGain.gain.setTargetAtTime(.04+carPhys.accelInput*.06,actx.currentTime,.06);
      slpGain.gain.setTargetAtTime(st.slip>.28?.06:0,actx.currentTime,.12);
    }

    // è»¢è½ãƒªã‚»ãƒƒãƒˆ
    if(carPhys.pos.y<-30){
      carPhys.pos.set(carPhys.pos.x,getH(carPhys.pos.x,carPhys.pos.z)+4,carPhys.pos.z);
      carPhys.vel.set(0,0,0);carPhys.angVel=0;
    }

    // HUD
    if(frame%2===0){
      $('spd').textContent=Math.abs(Math.floor(st.speedKmh));
      $('rpmbar').style.width=(st.rpm/7500*100)+'%';
      $('ipos').textContent=`POS: ${Math.floor(carPhys.pos.x)}, ${Math.floor(carPhys.pos.z)}`;
      $('ichk').textContent=`CHUNKS: ${chunkMap.size}`;
      $('inpc').textContent=`NPCs: ${npcList.length} | FPS: ${Math.round(1/Math.max(dt,.001))}`;
      drawMM(carPhys.pos.x,carPhys.pos.z,carPhys.yaw);
    }
  });

  // åˆæœŸãƒãƒ£ãƒ³ã‚¯
  for(let dx=-RDIST;dx<=RDIST;dx++)for(let dz=-RDIST;dz<=RDIST;dz++)createChunk(dx,dz);
}
</script>
</body>
</html>
